\section{Motivation}
\begin{frame}{Structural Attacks}{Invariant Subspaces}
    \begin{block}{Invariant Subspaces~\cite{C:GAAZ11} (Crypto 2011)}
        \vspace{0.25em}
        Let $U$ be a subspace of $\F_2^n$, and $F : \F_2^n \to \F_2^n$.
        We write $\coset{U}{a} \through{F} \coset{U}{b}$, if
        \begin{equation*}
            \exists a : \exists b : F(\coset{U}{a}) = \coset{U}{b}
        \end{equation*}
    \end{block}
    \begin{block}{Main Idea}
    \begin{center}
        \begin{tikzpicture}[scale=0.8]
            \tikzstyle{every node}=[transform shape];

            \node (left1-space) [draw,rectangle,thick,rounded corners,minimum width=3cm,minimum height=4cm,fill=white] at (-8,0)
            {\begin{tikzpicture}[scale=0.7]
                    \node (u) [draw,rectangle,thick, fill=gray!20]
                    {\begin{tikzpicture}[scale=1.2]
                            \draw[rounded corners=2pt]
                                (-1.2,1.9) -- (-1,1.9) -- (-0.9,1.7) -- (-1.1,1.2) -- (-1,0.9) -- (-1.4,0.6) -- (-1.1,0.1) -- (-1.2,-0.4) -- (-1.5,-0.2) -- (-1.8,-0.3) -- (-2.2,-0.6) -- (-2.7,-0.3) -- (-2.2,0.8) -- (-2.4,1) -- (-2.6,1) -- (-2.7,1.2) -- (-2.6,1.8) -- (-2.3,1.8) -- (-2.1,2.2) -- (-1.6,2.3) -- (-1.4,2.3) -- (-1.4,2.1) -- (-1.3,2) -- (-1.2,1.9);
                    \end{tikzpicture}};
            \end{tikzpicture}};

            \node (right1-space) [draw,rectangle,thick,rounded corners,minimum width=3cm,minimum height=4cm,fill=white] at (-4,0)
            {\begin{tikzpicture}[scale=0.7]
                    \node (u) [draw,rectangle,thick, fill=gray!10] {%
                        \begin{tikzpicture}[scale=1.2]
                            \draw[rounded corners=2pt, fill=gray!20]
                                (-1.2,1.9) -- (-1,1.9) -- (-0.9,1.7) -- (-1.1,1.2) -- (-1,0.9) -- (-1.4,0.6) -- (-1.1,0.1) -- (-1.2,-0.4) -- (-1.5,-0.2) -- (-1.8,-0.3) -- (-2.2,-0.6) -- (-2.7,-0.3) -- (-2.2,0.8) -- (-2.4,1) -- (-2.6,1) -- (-2.7,1.2) -- (-2.6,1.8) -- (-2.3,1.8) -- (-2.1,2.2) -- (-1.6,2.3) -- (-1.4,2.3) -- (-1.4,2.1) -- (-1.3,2) -- (-1.2,1.9);
                        \end{tikzpicture}
                    };
            \end{tikzpicture}};

            \draw[-latex] (-8,0.5) to [bend left] node[above]{$F$}
                                                  node[below,yshift=-17.5pt]{\repeatarrow} (-4,0.5);
            \draw[-latex] (-4.75,-0.5) to [bend left] node[below]{$F^{-1}$} (-7.25,-0.5);
        \end{tikzpicture}
    \end{center}
    \end{block}
\end{frame}

\begin{frame}{Structural Attacks}{Subspace Trail Cryptanalysis}
    \begin{block}{Subspace Trail Cryptanalysis~\cite{ToSC:GraRecRon16} (Last Year's FSE)}
        \vspace{0.25em}
        Let $U$, $V$ be subspaces of $\F_2^n$, and $F : \F_2^n \to \F_2^n$.
        We write $U \through{F} V$, if
        \begin{equation*}
            \forall a : \exists b : F(\coset{U}{a}) \subseteq \coset{V}{b}
        \end{equation*}
    \end{block}
    We restrict ourselves to \emph{essential} subspace trails.
    \begin{block}{Main Idea}
        \centering
        \vspace{0.25em}
        \begin{tikzpicture}[scale=0.8]
            \tikzstyle{every node}=[transform shape];

            \node (left2-space) [draw,rectangle,thick,rounded corners,minimum width=3cm,minimum height=4cm,fill=white] at (1,0) {};
            \draw[thick] (left2-space.west)+(0,1.125cm) -- node[above, yshift=1.5mm] {$\coset{U}{a_s}$} +(3cm,1.125cm);
            \draw[thick] (left2-space.west)+(0,-0.25cm) -- node[above, yshift=5mm] {\dots} +(3cm,-0.25cm);
            \draw[thick] (left2-space.west)+(0,-1.125cm) -- node[above, yshift=1.5mm] {$\coset{U}{a_2}$}
                                                            node[below, yshift=-1.5mm] {$\coset{U}{a_1}$} +(3cm,-1.125cm);

            \node (right2-space) [draw,rectangle,thick,rounded corners,minimum width=3cm,minimum height=4cm,fill=white] at (5,0) {};
            \draw[thick] (right2-space.north)+(0pt,-0.5pt) -- node[above, yshift=0.5mm, rotate=45] {$\coset{V}{b_t}$} +(-1.5cm,-1.5cm);
            \draw[thick] (right2-space.east)+(-0.5pt,1cm) -- node[above, yshift=10mm, rotate=45] {\dots} +(-3cm+1.25pt,-2cm+1.25pt);
            \draw[thick] (right2-space.east)+(-0.5pt,-5mm) -- node[above, yshift=2.5mm, rotate=45] {$\coset{V}{b_2}$}
                                                        node[below, yshift=-0.5mm, rotate=45] {$\coset{V}{b_1}$} +(-1.5cm,-2cm);

            \node (right-f) at (3,0.375) {$F$};

            \draw[-latex] (1.75,-0.5) to [bend left] (5.5,-0.5);
            \draw[-latex] (1.75,-1.5) to [bend left] (5.75,-1.5);
            \draw[-latex] (1.75,+1.5) to [bend left] (3.75,+1.5);
        \end{tikzpicture}
    \end{block}
\end{frame}

\begin{frame}{The Problem}{How to search efficiently for Subspace Trails?}
    \visible<1->{%
    \begin{alertblock}{Security against Subspace Trails?}
        Given the round function $F : \F_2^n \to \F_2^n$ of an SPN cipher, prove the resistance against subspace trail attacks!
    \end{alertblock}
    }
    \visible<2->{%
    \begin{block}{Main problem: Too many possible starting points.}
        Already for initially one-dimensional subspaces there are $2^n$ possibilities.
    \end{block}
    }
    \visible<2->{%
    \begin{block}{Can't we just activate a single S-box and check to what this leads us?}
        \visible<3->{%
        \begin{center}
            The short answer is:\\No!\footnote{\visible<3->{The long answer is this talk.}}
        \end{center}
        }
    \end{block}
    }
\end{frame}

\begin{frame}{Outline}{}
    \begin{block}{Outline}
        \vspace{0.5em}
        \tableofcontents[sectionstyle=shaded/show]
    \end{block}
\end{frame}

\section{Intuition}
\begin{frame}{Preliminaries, Notations}
    \begin{block}{Subspace Complement}
        If $U$ is a subspace of $\F_2^n$, we denote by $U^\perp$ it's \emph{complement}:
        \vspace{-0.5em}
        \begin{equation*}
            U^\perp \coloneqq \set{u \in \F_2^n \given \forall x \in U: \angles{x, u} = 0}
            \vspace*{-0.5em}
        \end{equation*}
    \end{block}
    \begin{block}{Derivative}
        Let $F : \F_2^n \to \F_2^n$.
        We denote the \emph{derivative of $F$ in direction $u$} by
        \vspace*{-0.5em}
        \begin{equation*}
            \Delta_u(F)(x) \coloneqq F(x) + F(x + u)
            \vspace*{-0.5em}
        \end{equation*}
    \end{block}
    \begin{block}{Linear Structure}
        Let $F : \F_2^n \to \F_2^n$.
        Then $(\alpha, u)$ is called a \emph{linear structure}, if
        \vspace*{-0.5em}
        \begin{equation*}
            \exists c \in \F_2 : \forall x \in \F_2^n : \angles{\alpha, \Delta_u(F)(x)} = c
            \vspace*{-0.5em}
        \end{equation*}
    \end{block}
\end{frame}

\begin{frame}{Intuition}{The Image of the Derivative is in the Subspace}
    \begin{minipage}{0.9775\textwidth}
    \begin{lemma}
        \vspace{0.5em}
        Let $U \through{F} V$ be a subspace trail.
        Then
        \begin{equation*}
            \forall u \in U : \mathrm{Im}\parens{\Delta_u(F)} \subseteq V.
        \end{equation*}
    \end{lemma}
    \end{minipage}
    \begin{columns}[t,onlytextwidth]
        \begin{column}{0.45\textwidth}
            \begin{block}{Remember:}
                \begin{tikzpicture}[scale=0.75]
                    \tikzstyle{every node}=[transform shape];

                    \node (left2-space) [draw,rectangle,thick,rounded corners,minimum width=3cm,minimum height=4cm,fill=white] at (1,0) {};
                    \draw[thick] (left2-space.west)+(0,1.125cm) -- node[above, yshift=1.5mm] {$\coset{U}{a_s}$} +(3cm,1.125cm);
                    \draw[thick] (left2-space.west)+(0,-0.25cm) -- node[above, yshift=5mm] {\dots} +(3cm,-0.25cm);
                    \draw[thick] (left2-space.west)+(0,-1.125cm) -- node[below, yshift=-1.5mm] {$\coset{U}{a_1}$} +(3cm,-1.125cm);

                    \node (right2-space) [draw,rectangle,thick,rounded corners,minimum width=3cm,minimum height=4cm,fill=white] at (5,0) {};
                    \draw[thick] (right2-space.north)+(0pt,-0.5pt) -- node[above, yshift=0.5mm, rotate=45] {$\coset{V}{b_t}$} +(-1.5cm,-1.5cm);
                    \draw[thick] (right2-space.east)+(-0.5pt,1cm) -- node[above, yshift=10mm, rotate=45] {\dots} +(-3cm+1.25pt,-2cm+1.25pt);
                    \draw[thick] (right2-space.east)+(-0.5pt,-5mm) -- node[below, yshift=-0.5mm, rotate=45] {$\coset{V}{b_1}$} +(-1.5cm,-2cm);

                    \node[xshift=-20pt, yshift=-23pt] (x1) at (left2-space) {$\cdot$};
                    \node[above] (x1-label) at (x1) {$x_1$};
                    \node[xshift=25pt, yshift=-20pt] (x2) at (left2-space) {$\cdot$};
                    \node[above] (x2-label) at (x2) {$x_2$};
                    \draw[latex-latex] (x1) -- node[below] {$u$} (x2);

                    \node[xshift=29pt, yshift=-3pt] (y1) at (right2-space) {$\cdot$};
                    \node[above] (y1-label) at (y1) {$y_1$};
                    \node[xshift=-5pt, yshift=-43pt] (y2) at (right2-space) {$\cdot$};
                    \node[above] (y2-label) at (y2) {$y_2$};
                    \draw[latex-latex] (y1) -- node[below,xshift=2pt] {$v$} (y2);

                    \draw[-latex] (x1) to [bend left] node[below,yshift=-5pt] {$F$} (y1);
                    \draw[-latex] (x2) to [bend left] (y2);
                \end{tikzpicture}
            \end{block}
        \end{column}
        \begin{column}{0.45\textwidth}
            \begin{block}{Proof}
                \vspace{0.5em}
                Let $U \through{F} V$, then for every $u \in U$
                \begin{align*}
                    x \in \coset{U}{x} &\through{F} F(x) \in \coset{V}{b}, \\
                    x+u \in \coset{U}{x} &\through{F} F(x+u) \in \coset{V}{b},
                \end{align*}
                implying $F(x) + F(x + u) \in V$.
                \qed{}
                \vspace{0.5em}
            \end{block}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}{Link to Truncated Differentials}
    \begin{block}{Definition~\cite{FSE:Knudsen94,FSE:BloLeaNyb14}}
        Let $F : \F_2^n \to \F_2^n$.
        A \emph{truncated differential} of probability one is a pair of affine subspaces $\coset{U}{s}$ and $\coset{V}{t}$, \st/
        \begin{equation*}
            \forall u \in U : \forall x \in \F_2^n : \Delta_{u + s}(F)(x) \in \coset{V}{t}
        \end{equation*}
    \end{block}
    \begin{itemize}
        \item Direct consequence from Lemma 1:
    \end{itemize}
    \begin{block}{Link: Subspaces Trails are Truncated Differentials with probability one}
        \vspace{0.5em}
        Let $U \through{F} V$ be a subspace trail.
        Then $\coset{U}{0}$ and $\coset{V}{0}$ are a truncated differential with probabiliy one.
        \vspace{0.5em}
    \end{block}
\end{frame}

\section{Algorithm}
\begin{frame}{Approach to the Algorithm}
    \vspace{-1em}
    \begin{columns}[t,onlytextwidth]
        \begin{column}{0.6\textwidth}
            \begin{block}{SPN Structure\vphantom{y}}
                \vspace{0.5em}
                \begin{tikzpicture}
                \foreach \z in {0,1,2,3} {%
                    \node[] (i\z) at ($(-0.25, \z*3em)+(0,0.35)$) {};
                    \node[] (o\z) at ($\z*(0, 3em)+(18.25em,0.35)$) {};
                    \draw[thick,solid] (i\z) -- (o\z.center);
                }

                %% SBoxes
                \foreach \z in {0,1,2,3} {%
                    \node[draw,thick,solid,minimum width=2em,minimum height=2.75em,fill=white] (sl\z) at ($(0,\z*3em) + (2em,1.1em)$) {$S$};
                }
                %% Permutation Box
                \node[draw,thick,solid,minimum width=2em,minimum height=11.75em,fill=white] (p1) at ($(1.125em,0) + (3.125em,5.6em)$) {$P$};

                %% Round Dashed Box
                \draw[thick,dashed] ($(sl3.north west)+(-0.25em,0.15)$) rectangle ($(p1.south east)+(0.35em,-0.15)$);


                %% SBoxes
                \foreach \z in {0,1,2,3} {%
                    \node[draw,thick,solid,minimum width=2em,minimum height=2.75em,fill=white] (sm\z) at ($(2.125,\z*3em) + (2em,1.1em)$) {$S$};
                }
                %% Permutation Box
                \node[draw,thick,solid,minimum width=2em,minimum height=11.75em,fill=white] (p2) at ($(5.5125em,0) + (4.8em,5.6em)$) {$P$};

                %% Round Dashed Box
                \draw[thick,dashed] ($(sm3.north west)+(-0.25em,0.15)$) rectangle ($(p2.south east)+(0.35em,-0.15)$);


                %% SBoxes
                \foreach \z in {0,1,2,3} {%
                    \node[draw,thick,solid,minimum width=2em,minimum height=2.75em,fill=white] (sr\z) at ($(4.25,\z*3em) + (2em,1.1em)$) {$S$};
                }
                %% Permutation Box
                \node[draw,thick,solid,minimum width=2em,minimum height=11.75em,fill=white] (p3) at ($(11.525em,0) + (4.8em,5.6em)$) {$P$};

                %% Round Dashed Box
                \draw[thick,dashed] ($(sr3.north west)+(-0.25em,0.15)$) rectangle ($(p3.south east)+(0.35em,-0.15)$);
                \end{tikzpicture}
                \vspace{0.5em}
            \end{block}
        \end{column}
        \begin{column}{0.3325\textwidth}
            \begin{block}{Easy parts}
                \vspace{4mm}
                \begin{itemize}
                    \item Given a starting subspace, computing the trail is easy.
                    \item The effect of the linear layer $P$ to a subspace $U$ is clear:
                          \begin{equation*}
                              U \through{P} P(U)
                          \end{equation*}
                \end{itemize}
                \vspace{3.75mm}
            \end{block}
        \end{column}
    \end{columns}
    \begin{minipage}{0.979\textwidth}
    \begin{block}{How to reduce the number of starting points?}
        Two possibilities, depending on the S-box $S$.
    \end{block}
    \end{minipage}
\end{frame}

\begin{frame}{Possibility I}{The short one}
    \begin{block}{Observation}
        \vspace{0.25em}
        For an S-box $S$ and $U \through{S} V$, because of the above lemma,
        \begin{align*}
            \forall x, \forall u \in U&: \Delta_u(S)(x) \in V \\
            \Rightarrow \forall \alpha \in V^\perp : \forall x, \forall u \in U &: \angles{\alpha, \Delta_u(S)(x)} = 0.
        \end{align*}
        Thus, $V^\perp$ consists of the linear structures of $S$.
    \end{block}
    \begin{theorem}
        Let $F : \F_2^{kn} \to \F_2^{kn}$ be an S-box layer that applies $k$ S-boxes with no non-trivial linear structures in parallel.
        Then every essential subspace trail $U \through{F} V$ is of the form
        \begin{equation*}
            U = V = U_1 \times \cdots \times U_k,
        \end{equation*}
        where $U_i \in \set{\set{0}, \F_2^n}$.
    \end{theorem}
\end{frame}

\begin{frame}{Possibility I}{Algorithm}
    \begin{columns}[t,onlytextwidth]
        \begin{column}{0.5\textwidth}
            \begin{block}{Algorithm}
                \begin{minipage}[t][30pt][t]{\textwidth}
                \begin{itemize}
                    \item Simply activate single S-boxes
                    \item Compute resulting subspace trail
                \end{itemize}
                \end{minipage}
            \end{block}
        \end{column}
        \begin{column}{0.4\textwidth}
            \begin{block}{Complexity}
                \begin{minipage}[t][30pt][t]{\textwidth}
                \vspace{2pt}
                Linear in the number of S-boxes.
                \end{minipage}
            \end{block}
        \end{column}
    \end{columns}
    \vspace{0.5em}
    In particular, in this case, bounds from activating single S-boxes are optimal.\\[1em]
    This approach is independent of the S-box, \ie/ any S-box without linear structures behaves the same with respect to subspace trails.
    \visible<2->{%
    \begin{minipage}{0.9775\textwidth}
    \begin{block}{The problem with S-boxes that have linear structures}
        Subspace trails through S-box layers with \emph{one}-linear structures are not necessarily a direct product of subspaces (see \eg/ Present).
    \end{block}
    \end{minipage}
    }
\end{frame}

\begin{frame}{Possibility II}{The long one, but only the idea}
    \begin{columns}[t,onlytextwidth]
        \begin{column}{0.55\textwidth}
            \begin{block}{Observation\vphantom{g}}
                \vspace{0.25em}
                If $U_1 \through{F} U_2$ is a subspace, then for any $V_1 \subseteq U_1$ there exists a $V_2 \subseteq U_2$, \st/ $V_1 \through{F} V_2$:
                \begin{equation*}
                \begin{aligned}
                    & U_1 & \stackrel{F}{\longrightarrow}\ &\ U_2 \\
                    & \rotatebox[origin=c]{90}{$\subseteq$} & &\ \rotatebox[origin=c]{90}{$\subseteq$} \\
                    & V_1 & \stackrel{F}{\longrightarrow}\ &\ V_2
                \end{aligned}
                \end{equation*}
            \end{block}
            \begin{block}{Complexity (Size of $\mathbb{W}$)}
                For an S-box layer $F : \F_2^{kn} \to \F_2^{kn}$ with $k$ S-boxes, each $n$-bit: $\abs{\mathbb{W}} = k \cdot 2^n$
            \end{block}
        \end{column}
        \begin{column}{0.4\textwidth}
            \begin{block}{Algorithm Idea}
                \begin{minipage}[t][146.5pt][t]{\textwidth}
                \vspace{1em}
                \begin{itemize}
                    \item Find a good set $\mathbb{W}$, \st/ for any possible subspace trail over the S-box layer $U \through{F} V$, there is an element $W \in \mathbb{W}$ \st/ $\set{W} \subseteq V$.
                \vspace{1em}
                    \item Compute the subspace trails for any starting point $W \in \mathbb{W}$.
                \end{itemize}
                \vspace{1em}
                \end{minipage}
            \end{block}
        \end{column}
    \end{columns}
\end{frame}

%\begin{frame}{Results}{No linear structures}
%    \begin{block}{SPN ciphers with S-boxes without linear structures}
%        \centering
%        \renewcommand{\arraystretch}{1.2}
%        \begin{tabular}{lrrrr}
%            \toprule
%            Cipher                            & $r_e$ & $d$ & $r_d$ & $d$ \\
%            \midrule
%            AES                               &  2  &  32 &     2    &  32 \\ \rowcolor{gray!10}
%            Anubis                            &  2  & 104 &    ---   & --- \\
%            Klein                             &  3  &  60 &     2    &  32 \\ \rowcolor{gray!10}
%            Kuznyechik                        &  1  &   8 &     1    &   8 \\
%            Prince                            &  2  &  16 &     2    &  16 \\ \rowcolor{gray!10}
%            Qarma                             &  2  &  36 &     2    &  36 \\
%            \bottomrule
%        \end{tabular}
%    \end{block}
%\end{frame}
%
%\begin{frame}{Results}{One-linear structures}
%    \begin{block}{SPN ciphers with S-boxes with linear structures}
%        \centering
%        \renewcommand{\arraystretch}{1.2}
%        \begin{tabular}{lrrrrcrrrr}
%            \toprule
%                        & \multicolumn{4}{c}{LS} & & \multicolumn{4}{c}{\visible<2->{No LS}} \\
%            Cipher      & $r_e$   &   $d$   &    $r_d$   &  $d$  & & \visible<2->{$r_e$} & \visible<2->{$d$} & \visible<2->{$r_d$} & \visible<2->{$d$} \\
%            \midrule
%            Ascon       &   3     &   298   &      1     &  125  & & \visible<2->{3} & \visible<2->{ 310} & \visible<2->{1} & \visible<2->{155} \\ \rowcolor{gray!10}
%            Gift        &   3     &    60   &      3     &   60  & & \visible<2->{2} & \visible<2->{  16} & \visible<2->{2} & \visible<2->{ 16} \\
%            Keccak      &   2     &   546   &      1     &  169  & & \visible<2->{2} & \visible<2->{1290} & \visible<2->{1} & \visible<2->{270} \\ \rowcolor{gray!10}
%            Present     &   3     &    43   &      3     &   63  & & \visible<2->{2} & \visible<2->{  16} & \visible<2->{2} & \visible<2->{ 16} \\
%            Pride       &   2     &    31   &      2     &   34  & & \visible<2->{2} & \visible<2->{  56} & \visible<2->{1} & \visible<2->{ 40} \\ \rowcolor{gray!10}
%            Qarma       &   2     &    36   &      2     &   36  & & \visible<2->{2} & \visible<2->{  36} & \visible<2->{2} & \visible<2->{ 36} \\
%            Serpent     &   2     &    88   &      2     &   62  & & \visible<2->{2} & \visible<2->{ 100} & \visible<2->{2} & \visible<2->{ 68} \\ \rowcolor{gray!10}
%            Skinny64    &   5     &    48   &      5     &   48  & & \visible<2->{4} & \visible<2->{  48} & \visible<2->{4} & \visible<2->{ 48} \\
%            Skinny128   &   5     &    96   &      5     &   96  & & \visible<2->{5} & \visible<2->{  96} & \visible<2->{5} & \visible<2->{ 96} \\ %\rowcolor{gray!10}
%            \bottomrule
%        \end{tabular}
%    \end{block}
%\end{frame}
